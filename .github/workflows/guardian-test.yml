name: CI/CD Guardian Live Demo (Shows Recommendation + URGENT)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  demo-guardian:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Critical Failure Scenario
        run: |
          echo "Simulating FAILED + SLOW + 2 CVEs build..."

      - name: Call CI/CD Guardian Agent → See Full Recommendation
        id: guardian
        run: |
          RESPONSE=$(curl -s -X POST "${{ secrets.GUARDIAN_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d '{
              "pipeline_id": "demo-critical-${{ github.run_id }}",
              "status": "failed",
              "duration_seconds": 985,
              "logs": "pytest: 57 failed | npm ERR! | Snyk found critical issues",
              "vulnerabilities": ["CVE-2025-1337", "CVE-2025-9999"],
              "branch": "main",
              "commit_sha": "${{ github.sha }}"
            }')

          echo "$RESPONSE" | jq -r .

          # Extract and highlight key fields
          SEVERITY=$(echo "$RESPONSE" | jq -r '.severity')
          RECOMMENDATION=$(echo "$RESPONSE" | jq -r '.recommendation')
          ANOMALIES=$(echo "$RESPONSE" | jq -r '.anomalies[]' | wc -l)

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "   CI/CD GUARDIAN AGENT RESULT"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Severity       → $SEVERITY"
          echo "Anomalies found → $ANOMALIES"
          echo "Recommendation → $RECOMMENDATION"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Make URGENT message impossible to miss
          if [[ "$SEVERITY" == "critical" ]]; then
            echo "::error::CRITICAL PIPELINE ISSUES DETECTED!"
            echo "::error::$RECOMMENDATION"
          fi

          # Save for later steps (optional)
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
